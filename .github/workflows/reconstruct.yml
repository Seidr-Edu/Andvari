name: Reconstruct Java Repo

on:
  push:
  workflow_dispatch:
    inputs:
      run_id:
        description: "Unique run identifier (optional, autogenerated if empty)"
        required: false
        default: ""
        type: string
      diagram_path:
        description: "Path to input PlantUML diagram"
        required: false
        default: "examples/diagram.puml"
        type: string

jobs:
  reconstruct:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve run id and workspace
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${{ github.event.inputs.run_id }}" ]]; then
            RUN_ID="${{ github.event.inputs.run_id }}"
          else
            RUN_ID="gh-${{ github.run_id }}-${{ github.run_attempt }}"
          fi

          RUN_DIR="runs/${RUN_ID}"
          INPUT_DIR="${RUN_DIR}/input"
          NEW_REPO_DIR="${RUN_DIR}/new_repo"
          LOGS_DIR="${RUN_DIR}/logs"
          OUTPUTS_DIR="${RUN_DIR}/outputs"

          mkdir -p "${INPUT_DIR}" "${NEW_REPO_DIR}" "${LOGS_DIR}" "${OUTPUTS_DIR}"

          echo "run_id=${RUN_ID}" >> "$GITHUB_OUTPUT"
          echo "run_dir=${RUN_DIR}" >> "$GITHUB_OUTPUT"
          echo "input_dir=${INPUT_DIR}" >> "$GITHUB_OUTPUT"
          echo "new_repo_dir=${NEW_REPO_DIR}" >> "$GITHUB_OUTPUT"
          echo "logs_dir=${LOGS_DIR}" >> "$GITHUB_OUTPUT"
          echo "outputs_dir=${OUTPUTS_DIR}" >> "$GITHUB_OUTPUT"

      - name: Copy diagram into isolated input directory
        shell: bash
        run: |
          set -euo pipefail
          DIAGRAM_PATH="${{ github.event.inputs.diagram_path }}"
          if [[ ! -f "${DIAGRAM_PATH}" ]]; then
            echo "diagram_path does not exist: ${DIAGRAM_PATH}" >&2
            exit 1
          fi

          cp "${DIAGRAM_PATH}" "${{ steps.prep.outputs.input_dir }}/diagram.puml"

      - name: Set up Java 25
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '25'
          cache: maven

      - name: Mock model reconstruction (isolated)
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/mock_reconstruct.sh \
            "${{ steps.prep.outputs.input_dir }}/diagram.puml" \
            "${{ steps.prep.outputs.new_repo_dir }}"

      - name: Run gate in isolated repo
        shell: bash
        run: |
          set -euo pipefail
          cp gate_recon.sh "${{ steps.prep.outputs.new_repo_dir }}/gate_recon.sh"
          chmod +x "${{ steps.prep.outputs.new_repo_dir }}/gate_recon.sh"

          (
            cd "${{ steps.prep.outputs.new_repo_dir }}"
            ./gate_recon.sh | tee "../logs/gate_recon.log"
          )

      - name: Persist outputs metadata
        shell: bash
        run: |
          set -euo pipefail
          cat > "${{ steps.prep.outputs.outputs_dir }}/summary.txt" <<TXT
          Run ID: ${{ steps.prep.outputs.run_id }}
          Diagram: ${{ github.event.inputs.diagram_path }}
          Workspace: ${{ steps.prep.outputs.run_dir }}
          TXT

      - name: Upload reconstruction artifacts
        uses: actions/upload-artifact@v4
        with:
          name: reconstructed-${{ steps.prep.outputs.run_id }}
          path: ${{ steps.prep.outputs.run_dir }}
          if-no-files-found: error
